name: CI

on: [push, pull_request]

permissions:
  contents: read
  packages: write

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start app in background
        run: |
          nohup python app.py > app.log 2>&1 &
          sleep 3

      - name: Wait for health endpoint
        run: |
          for i in {1..30}; do
            if curl -sS http://127.0.0.1:8080/health | grep -q '"status": "healthy"'; then
              echo "Health OK"; break
            fi
            sleep 1
          done

      - name: Run smoke tests
        run: python scripts/test_caseworker_create.py

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/his-backend:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/his-backend:latest

      - name: Output image
        run: echo "Pushed image: ghcr.io/${{ github.repository_owner }}/his-backend:${{ github.sha }}"

  # Optional: deploy to Railway if secrets are provided
  deploy_to_railway:
    needs: build_and_test
    if: ${{ secrets.RAILWAY_API_KEY != '' && secrets.RAILWAY_SERVICE_ID != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -sSL https://railway.app/install.sh | sh

      - name: Login to Railway
        env:
          RAILWAY_API_KEY: ${{ secrets.RAILWAY_API_KEY }}
        run: |
          railway login --apiKey "$RAILWAY_API_KEY"

      - name: Deploy image to Railway service
        env:
          IMAGE: ghcr.io/${{ github.repository_owner }}/his-backend:${{ github.sha }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          # Deploying via Railway CLI by updating the service to use the new image.
          # This command may require the Railway project to be pre-configured.
          railway service deploy --serviceId "$RAILWAY_SERVICE_ID" --image "$IMAGE" || echo "Railway deploy command failed or not supported in this environment"
